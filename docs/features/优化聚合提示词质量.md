# 优化聚合提示词质量 - 需求文档

> 生成时间：2025-11-27
> 基于项目：Creeper v1.6.0
> 技术栈：Python 3.8+ + DeepSeek API + OpenAI SDK

---

## 项目概况

**技术栈**：Python 3.8+ + asyncio + DeepSeek API + Redis 缓存
**架构模式**：模块化 (文件扫描 → 增量检测 → LLM 聚合 → 输出保存)
**代码风格**：snake_case 命名 / 中文注释和文档字符串

---

## 改动点

### 要实现什么

**核心问题**：
1. 当前默认提示词 (`code_summary.txt`, `doc_merge.txt`) 生成的内容质量不符合要求
2. 代码总结时未能提取文档精华，输出过于泛化
3. 文档合并时丢失关键细节信息

**改进目标**：
- 代码总结：保留架构设计、关键实现细节、依赖关系、使用示例、注意事项
- 文档合并：保留核心概念、操作步骤、配置说明、最佳实践、常见问题
- 防止 LLM 输出被 markdown 代码块包裹（当前 `aggregators/code_summary.md` 第1行有 ` ```markdown `）
- 防止 LLM 引用不存在的文件名（当前输出引用了 `claude-code-最佳实践-anthropic.md` 等不存在的文件）

### 与现有功能的关系
- 修改现有提示词模板：`prompts/code_summary.txt`, `prompts/doc_merge.txt`
- 不改变 `src/file_aggregator.py` 的核心逻辑
- 不改变 `src/prompt_templates.py` 的加载机制

### 新增依赖
无

---

## 实现方案

### 需要修改的文件
```
prompts/code_summary.txt      # 优化代码总结提示词
prompts/doc_merge.txt         # 优化文档合并提示词
```

### 需要新增的文件
```
tests/file_aggregator/test_prompt_quality.py  # 提示词质量测试（可选，未来实现）
```

### 实现步骤

**步骤 1：分析信息保留需求**
- [ ] 代码总结应保留：
  - 架构设计模式（分层、模块化、依赖注入等）
  - 关键类/函数的输入输出和核心算法
  - 技术栈和外部依赖（库、框架、API）
  - 配置项和环境变量
  - 使用示例（CLI 命令、API 调用）
  - 错误处理和边界条件
  - 性能优化点和限制

- [ ] 文档合并应保留：
  - 核心概念定义和术语表
  - 分步操作指南（安装、配置、使用）
  - 配置选项的完整说明（参数、默认值、作用）
  - 最佳实践和使用建议
  - 常见问题和解决方案
  - 示例代码和命令
  - 注意事项和已知限制

**步骤 2：重写 `code_summary.txt` 提示词**
- [ ] 明确角色定位和输出目标
- [ ] 添加详细的信息提取指令（见上述保留需求）
- [ ] 添加输出格式约束（禁止代码块包裹、必须使用实际文件路径）
- [ ] 添加增量更新策略（如何合并新文件信息）
- [ ] 添加质量检查指令（避免泛化、避免臆测不存在的内容）

**步骤 3：重写 `doc_merge.txt` 提示词**
- [ ] 明确文档整合的优先级（核心信息 > 示例 > 补充说明）
- [ ] 添加去重规则（相同概念不重复，相同示例合并）
- [ ] 添加结构化要求（目录层级、段落组织）
- [ ] 添加输出格式约束（禁止代码块包裹）

**步骤 4：测试优化效果**
- [ ] 使用 `aggregators/code_summary.md` 所用的源文件重新生成，对比质量
- [ ] 测试增量更新场景（新增文件后再次聚合）
- [ ] 测试不同类型的代码文件（工具脚本、库模块、配置文件）
- [ ] 测试不同类型的文档（教程、API 文档、README）

**步骤 5：文档更新**
- [ ] 更新 CHANGELOG.md
- [ ] 检查 CLAUDE.md 是否需要更新提示词编写指南
- [ ] 无需更新 README.md（内部优化，不影响用户使用方式）

**步骤 6：提交代码**
- [ ] 使用 git 提交优化后的提示词

---

## 优化后的提示词设计

### code_summary.txt（代码总结）

**新增约束**：
1. **禁止输出包裹**：直接输出 Markdown 文档，不使用 ` ```markdown ` 代码块
2. **使用实际文件路径**：引用文件时必须使用提供的完整路径（如 `src/file_aggregator.py`），不得臆造不存在的文件名
3. **深度分析**：不仅列出类/函数名，还要说明其核心算法、输入输出、异常处理
4. **依赖关系**：明确模块间的调用关系和数据流向
5. **实现细节**：提取关键设计决策（如 Redis 缓存策略、异步并发控制）

**输出结构**：
```
# {项目/模块名} 代码总结

## 架构概览
- 整体设计模式
- 核心数据流
- 模块依赖关系图（Mermaid 可选）

## 模块详解
### 模块1: {实际文件路径}
- **功能**：...
- **关键类/函数**：
  - `ClassName.method(params) -> return_type`: 功能描述 + 核心算法
- **依赖**：依赖哪些外部库/内部模块
- **配置**：相关的环境变量或配置项

## 技术栈
- 语言/框架版本
- 核心依赖库及其用途
- 外部服务（数据库、API）

## 使用示例
```bash
# 实际可运行的命令示例
```

## 注意事项
- 性能限制
- 已知问题
- 最佳实践
```

### doc_merge.txt（文档合并）

**新增约束**：
1. **禁止输出包裹**：直接输出 Markdown 文档
2. **信息优先级**：核心操作步骤 > 配置说明 > 示例代码 > 补充说明
3. **去重策略**：
   - 相同概念：保留最详细的描述，删除冗余版本
   - 相同示例：合并到同一代码块，添加场景说明
   - 相同配置项：合并为表格，标注默认值和必填项
4. **结构统一**：
   - 一级标题：功能/主题名称
   - 二级标题：安装、配置、使用、API、FAQ
   - 三级标题：具体操作或概念

**输出结构**：
```
# {功能/主题名称}

## 概述
- 一句话说明这是什么
- 核心功能列表
- 适用场景

## 安装/前置条件
- 依赖安装
- 环境要求

## 配置
| 配置项 | 类型 | 默认值 | 说明 | 必填 |
|--------|------|--------|------|------|
| ...    | ...  | ...    | ...  | ✓/✗  |

## 使用指南
### 基础用法
步骤 1：...
步骤 2：...

### 高级用法
- 场景1：...
- 场景2：...

## API 参考（如适用）
### 函数/类名
- **参数**：...
- **返回**：...
- **示例**：...

## 常见问题
**Q: ...**
A: ...

## 注意事项
- 限制条件
- 最佳实践
```

---

## 完成检查清单

**代码质量**：
- [x] 无需修改代码
- [x] 提示词使用中文，符合项目规范
- [x] 提示词明确禁止输出格式错误

**测试**：
- [ ] 重新生成 `aggregators/code_summary.md`，验证质量提升
- [ ] 测试增量更新场景
- [ ] 确认输出不包含代码块包裹
- [ ] 确认输出不引用不存在的文件

**文档**：
- [ ] README 无需更新（内部优化）
- [ ] CHANGELOG 已更新
- [ ] CLAUDE.md 已检查

---

## CHANGELOG.md 更新指南

**版本号规则**：PATCH 版本（v1.6.0 → v1.6.1）

**模板**：
```markdown
## [1.6.1] - 2025-11-27

### Changed
- **文件整合**：优化聚合提示词质量
  - 代码总结提示词增强：深度分析架构设计、依赖关系、实现细节
  - 文档合并提示词增强：保留核心信息、智能去重、结构化输出
  - 修复输出被 markdown 代码块包裹的问题
  - 修复 LLM 臆造不存在文件路径的问题
  - 相关文件：`prompts/code_summary.txt`, `prompts/doc_merge.txt`
```

**README.md 更新判断**：❌ 无需更新（内部优化，CLI 使用方式不变）

**CLAUDE.md 更新判断**：✓ 建议添加提示词编写最佳实践（可选）
- 如果决定添加，建议在 "重要实现细节" 部分新增 "提示词设计原则" 小节
- 内容：禁止输出包裹、使用实际文件路径、明确信息保留规则、结构化输出要求

---

## 提交代码

在需求实现完成后，按以下顺序操作：

```bash
# 1. 无需更新 README.md
# 2. 检查并更新 CLAUDE.md（如有必要）
# 3. 更新 CHANGELOG.md
# 4. 添加所有修改的文件
git add prompts/code_summary.txt prompts/doc_merge.txt CHANGELOG.md
# 5. 提交
git commit -m "fix: 优化聚合提示词质量，修复输出格式问题"
```

注意：
- 使用 `fix:` 前缀（修复质量问题）
- 如果选择扩展 CLAUDE.md，commit message 改为 `chore: 优化聚合提示词质量并更新开发规范`

---

## 注意事项

**技术风险**：
- 提示词变更可能导致不同 LLM 模型（如切换到 GPT/Claude）表现不一致
- 更详细的提示词可能增加 Token 消耗（当前提示词约 100 tokens，优化后预计 300-400 tokens）

**兼容性**：
- ✓ 向后兼容（不影响现有 API 和 CLI）
- ✓ 现有缓存仍然有效
- ✓ 增量更新逻辑不变

**测试建议**：
- 对比优化前后的输出质量（使用相同的输入文件）
- 测试极端情况：空文件、超大文件、特殊字符文件名
- 验证增量更新时 LLM 是否正确合并信息
