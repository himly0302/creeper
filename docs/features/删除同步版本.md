# 删除同步版本 - 需求文档

> 生成时间：2025-12-08
> 基于项目：Creeper (网页爬虫工具)
> 技术栈：Python 3.8+ + asyncio + Redis + Playwright

---

## 项目概况

**技术栈**：Python + asyncio + Redis + Playwright + Trafilatura
**架构模式**：基于异步 I/O 的模块化设计
**代码风格**：类继承体系、统一的错误处理、完善的日志记录

---

## 改动点

### 要实现什么
- 核心功能 1：删除所有同步版本的爬虫逻辑
- 核心功能 2：保留异步版本作为唯一的爬虫实现
- 核心功能 3：简化项目结构，减少重复代码

### 与现有功能的关系
- 依赖现有模块：BaseCrawler - 基础功能保留
- 需要修改：creeper.py - 移除 SyncCrawler 类
- 需要移除：fetcher.py - 同步获取器（功能已合并到 async_fetcher.py）

### 新增依赖
- 无需新增依赖

---

## 实现方案

### 需要修改的文件
```
creeper.py                      # 修改内容：删除 SyncCrawler 类，简化模式选择逻辑
src/base_crawler.py             # 修改内容：移除同步相关的方法引用
src/image_downloader.py         # 修改内容：删除 ImageDownloader 类
src/cli_parser.py               # 修改内容：删除 --sync 参数
tests/image_downloader/         # 修改内容：删除同步测试文件
```

### 需要新增的文件
```
tests/删除同步版本/              # ⚠️ 测试文件必须保存在 tests/ 目录下
├── test_async_only_mode.py    # 用途：验证异步模式正常工作
└── test_sync_removed.py       # 用途：验证同步逻辑已完全移除
```

### 实施步骤

**步骤 1：环境准备**
- [ ] 备份当前版本（git tag）
- [ ] 确认异步版本功能完整

**步骤 2：核心实现**
- [ ] 删除 SyncCrawler 类（creeper.py:31-168）
- [ ] 删除 --sync 参数处理逻辑
- [ ] 删除 fetcher.py 文件
- [ ] 删除同步图片下载器类

**步骤 3：更新现有系统**
- [ ] 修改 main() 函数，默认使用 AsyncCrawler
- [ ] 更新 cli_parser.py，移除 --sync 选项
- [ ] 更新 base_crawler.py，移除同步相关代码

**步骤 4：测试**
- [ ] 创建新测试文件（保存到 `tests/` 目录）
- [ ] 验证异步模式正常工作
- [ ] **回归测试所有现有功能**（必须！）

**步骤 5：文档更新**（必须执行）

使用 **Edit 工具**按以下标准判断并更新：

| 文档 | 需要更新 | 不需要更新 |
|------|----------|-----------|
| **CHANGELOG.md** | 每次功能完成后必须更新 | - |
| **README.md** | 删除 --sync 参数说明，更新安装配置流程 | - |
| **CLAUDE.md** | 更新开发命令，删除同步模式相关内容 | - |

**CHANGELOG.md 更新**（在 `## [Unreleased]` 下添加）：
```markdown
### Changed
- **架构**：移除同步爬虫模式，统一使用异步模式
  - 删除 `SyncCrawler` 类和 `--sync` 选项
  - 移除 `fetcher.py`，统一使用 `async_fetcher.py`
  - 相关文件：`creeper.py`, `src/fetcher.py`, `src/cli_parser.py`

### Removed
- **功能**：同步爬虫模式
  - 原因：简化代码结构，专注优化异步模式性能
```

**版本号规则**：此为破坏性变更 → MAJOR 版本 (v2.0.0)

**步骤 6：提交代码**（必须执行）

使用 **Bash 工具**执行：
```bash
git add .
git commit -m "feat: 移除同步爬虫模式，统一使用异步实现

- 删除 SyncCrawler 类和 --sync 参数选项
- 移除 src/fetcher.py，统一使用 AsyncWebFetcher
- 删除同步图片下载器
- 更新所有相关文档

🤖 Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>"
```

**步骤 7：自我检查**
- [ ] 异步模式是否正常工作
- [ ] 是否还有同步代码残留
- [ ] CHANGELOG.md 是否已更新
- [ ] README.md 是否已更新（删除 --sync）
- [ ] CLAUDE.md 是否已更新（删除同步模式命令）
- [ ] "实现步骤"与"需要修改/新增的文件"是否一致
- [ ] 所有相关文件是否已提交

---

## 使用方式

### 命令行
```bash
# 之前（同步模式）
python creeper.py inputs/input.md --sync

# 现在（统一异步模式）
python creeper.py inputs/input.md
```

### 配置项（无变化）
```json
{
  "CONCURRENCY": 10,  // 异步并发数
  "COOKIE_STORAGE": "redis"
}
```

---

## 注意事项

**技术风险**：确保所有同步功能在异步版本中都有对应实现
**兼容性**：此为破坏性变更，需要 MAJOR 版本升级
**迁移指南**：用户需要移除脚本中的 `--sync` 参数