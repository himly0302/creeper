# 删除本地持久化功能 - 需求文档

> 生成时间：2025-12-05
> 基于项目：Creeper
> 技术栈：Python 3.8+ + asyncio + Redis

---

## 项目概况

**技术栈**：Python 3.8+ + asyncio + Redis + Playwright
**架构模式**：模块化分层架构
**代码风格**：snake_case 命名 / 中文注释 / 类型提示

---

## 改动点

### 要实现什么
- 核心功能 1：完全删除本地持久化功能（ENABLE_LOCAL_PERSISTENCE）
- 核心功能 2：简化为纯 Redis 模式，移除所有本地 JSON 文件操作
- 核心功能 3：清理相关的配置项、缓存文件和文档
- 核心功能 4：更新清理脚本和相关工具

### 与现有功能的关系
- 依赖现有模块：DedupManager、CookieManager、ModelCapabilityManager - 需要简化存储逻辑
- 集成位置：多个核心模块的存储层
- 影响范围：去重、Cookie管理、模型能力探测等所有缓存相关功能

### 新增依赖（如有）
- 无（删除操作，简化依赖）

---

## 实现方案

### 需要修改的文件
```
src/config.py  # 删除 ENABLE_LOCAL_PERSISTENCE 相关配置项
src/dedup.py  # 简化 DedupManager，移除文件操作逻辑
src/cookie_manager.py  # 简化 CookieManager，移除混合存储模式
src/model_capabilities.py  # 简化 ModelCapabilityManager，移除文件缓存
.env.example  # 删除本地持久化相关配置注释
clean.sh  # 简化清理脚本，移除本地文件清理
CLAUDE.md  # 更新架构说明，删除混合存储相关描述
README.md  # 更新配置说明，删除本地持久化相关内容
CHANGELOG.md  # 添加删除记录
```

### 需要删除的文件
```
data/dedup_cache.json  # URL 去重本地缓存（如有）
data/cookies_cache.json  # Cookie 本地缓存（如有）
data/model_capabilities.json  # 模型能力本地缓存（如有）
tests/test_persistence.py  # 持久化功能测试（如有）
tests/test_restore.py  # 数据恢复测试（如有）
```

### 实施步骤

**步骤 1：环境准备**
- [ ] 确认没有正在运行的爬取任务
- [ ] 备份重要的本地缓存文件（如有需要）

**步骤 2：配置清理**
- [ ] 删除 src/config.py 中的 ENABLE_LOCAL_PERSISTENCE 相关配置
- [ ] 删除 DEDUP_CACHE_FILE、COOKIE_CACHE_FILE 等文件路径配置
- [ ] 删除 SYNC_INTERVAL_SECONDS 定期同步配置
- [ ] 更新 .env.example 删除相关注释

**步骤 3：核心模块简化**
- [ ] 简化 DedupManager：移除文件操作，保留 Redis 操作
- [ ] 简化 CookieManager：移除文件存储，仅保留 Redis 模式
- [ ] 简化 ModelCapabilityManager：移除本地文件缓存，仅保留 Redis 缓存

**步骤 4：测试和清理**
- [ ] 删除本地缓存文件
- [ ] 删除持久化相关测试文件
- [ ] 更新 clean.sh 脚本

**步骤 5：文档更新**
- [ ] 更新 CLAUDE.md：删除混合存储相关说明
- [ ] 更新 README.md：删除本地持久化配置说明
- [ ] 更新 CHANGELOG.md：记录删除操作

**步骤 6：回归测试**
- [ ] 测试爬虫功能正常工作（纯 Redis 模式）
- [ ] 测试 Cookie 管理功能（仅 Redis 模式）
- [ ] 测试翻译功能（仅 Redis 模式）

**步骤 7：文档更新**（必须执行）

使用 **Edit 工具**按以下标准判断并更新：

| 文档 | 需要更新 | 不需要更新 |
|------|----------|-----------|
| **CHANGELOG.md** | 每次功能完成后必须更新 | - |
| **README.md** | 删除本地持久化配置说明 | - |
| **CLAUDE.md** | 更新架构说明，删除混合存储描述 | - |

**CHANGELOG.md 更新**（在 `## [Unreleased]` 下添加）：
```markdown
### Removed
- **本地持久化功能**：简化为纯 Redis 模式，移除本地文件存储
  - 删除 ENABLE_LOCAL_PERSISTENCE 配置和相关逻辑
  - 简化 DedupManager、CookieManager、ModelCapabilityManager
  - 删除本地缓存文件和相关测试
  - 相关文件：`src/dedup.py`, `src/cookie_manager.py`, `src/model_capabilities.py`
```

**版本号规则**：删除功能 → MINOR 版本（如果 API 兼容）或 PATCH（小改进）

**步骤 8：提交代码**（必须执行）

使用 **Bash 工具**执行：
```bash
git add .
git commit -m "feat: 删除本地持久化功能

- 简化为纯 Redis 模式
- 移除本地文件存储逻辑
- 更新文档说明

🤖 Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>"
```

**步骤 9：自我检查**
- [ ] 本地持久化功能是否完全删除
- [ ] 爬虫功能是否正常（纯 Redis 模式）
- [ ] Cookie 管理是否正常（仅 Redis 模式）
- [ ] 翻译功能是否正常（仅 Redis 模式）
- [ ] CHANGELOG.md 是否已更新
- [ ] README.md 是否已更新
- [ ] CLAUDE.md 是否已更新
- [ "实现步骤"与"需要修改/新增的文件"是否一致
- [ ] 所有相关文件是否已提交

---

## 使用方式

### 删除后的变化
- 不再支持本地文件缓存，仅使用 Redis 存储
- Redis 连接失败时不再有本地文件降级
- 启动速度可能略有提升（无需加载本地文件）
- 内存使用可能略有增加（无本地文件缓存）

### 配置变化
删除以下配置项：
```bash
ENABLE_LOCAL_PERSISTENCE=true  # 不再需要
DEDUP_CACHE_FILE=data/dedup_cache.json  # 不再需要
COOKIE_CACHE_FILE=data/cookies_cache.json  # 不再需要
SYNC_INTERVAL_SECONDS=300  # 不再需要
```

### 行为变化
- **数据安全**：仅依赖 Redis，需要确保 Redis 的数据持久化配置
- **重启恢复**：不再从本地文件恢复数据
- **多实例**：多个实例共享同一 Redis 数据

---

## 注意事项

**技术风险**：
- Redis 成为单点故障，需要确保 Redis 高可用配置
- 数据完全依赖 Redis，需要配置 Redis 的持久化（RDB/AOF）
- 多实例部署时需要确保 Redis 连接配置正确

**兼容性**：
- 这是一个破坏性变更，需要更新版本号
- 用户需要确保 Redis 的数据持久化配置
- 可能需要提供数据迁移脚本

**数据迁移**：
- 如有重要数据，需要在删除前从本地文件迁移到 Redis
- 提供临时的数据导出工具

**性能影响**：
- 网络延迟增加（所有操作都需要访问 Redis）
- Redis 负载增加（无本地文件缓存分担）
- 内存使用可能增加

**部署建议**：
- 确保 Redis 服务器配置了数据持久化
- 配置 Redis 的主从复制或集群模式
- 监控 Redis 的连接状态和性能指标