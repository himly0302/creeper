# 图片本地化存储 - 需求文档

> 生成时间：2025-11-27
> 基于项目：Creeper v1.6.0
> 技术栈：Python 3.8+ + Trafilatura + aiohttp + Playwright

---

## 项目概况

**技术栈**：Python 3.8+ + Trafilatura (Markdown 提取) + aiohttp (异步 HTTP) + Playwright (动态渲染) + Redis (去重缓存)

**架构模式**：模块化分层架构
- **数据层**：`parser.py` (URL 解析) + `dedup.py` (去重)
- **爬取层**：`fetcher.py` / `async_fetcher.py` (内容获取)
- **存储层**：`storage.py` (Markdown 文件存储)
- **工具层**：`cleaner.py` (内容清洗) + `utils.py` (工具函数)

**代码风格**：
- 类名：PascalCase（`ImageDownloader`, `WebFetcher`）
- 方法名：snake_case（`download_image()`, `_fetch_static()`）
- 私有方法：`_` 前缀
- 异常处理：try-except + 日志 + 优雅降级
- 日志级别：INFO (成功), WARNING (降级), ERROR (失败), DEBUG (详细)

---

## 改动点

### 要实现什么
- **核心功能 1**：下载 Markdown 内容中的图片到本地目录，保存到 `output/<H1>/<H2>/images/<图片文件名>`
- **核心功能 2**：替换 Markdown 中的图片 URL 为本地相对路径（`![alt](images/<文件名>)` 格式）
- **核心功能 3**：支持同步和异步两种下载模式（兼容现有的同步/异步爬虫）
- **可选功能 4**：图片去重机制（相同 URL 的图片只下载一次，基于 Redis 缓存或文件 hash）
- **可选功能 5**：图片下载失败时保留原始 URL（不影响文档生成）

### 与现有功能的关系
- **依赖现有模块**：
  - `storage.py` - 需要修改 `_generate_markdown()` 方法，在保存前处理图片下载和 URL 替换
  - `fetcher.py` / `async_fetcher.py` - 传递 `WebPage` 对象时保留原始 HTML，用于提取图片 URL
  - `utils.py` - 复用 `sanitize_filename()` 函数生成图片文件名
  - `config.py` - 新增图片下载相关配置项
  - `dedup.py` - （可选）复用 Redis 连接实现图片去重

- **集成位置**：
  - `storage.py:67-116` - `_generate_markdown()` 方法，在保存前调用图片处理逻辑
  - `storage.py:32-65` - `save()` 方法，传递图片保存目录路径

### 新增依赖（如有）
- **无需新增依赖** - 使用现有的 `requests` / `aiohttp` 下载图片
- **可选依赖（增强功能）**：
  - `Pillow>=10.0.0` - 图片格式转换和验证（如需验证图片完整性）

---

## 实现方案

### 需要修改的文件
```
src/config.py             # 新增配置项：启用/禁用图片下载、最大图片大小、支持的格式
src/storage.py            # 修改 _generate_markdown() 和 save()，集成图片下载逻辑
src/fetcher.py            # （可选）保留原始 HTML，用于提取高清图片链接
src/async_fetcher.py      # （可选）保留原始 HTML，用于提取高清图片链接
.env.example              # 新增环境变量示例：DOWNLOAD_IMAGES、MAX_IMAGE_SIZE_MB
```

### 需要新增的文件
```
src/image_downloader.py         # 核心：图片下载器（同步和异步版本）
tests/image_downloader/          # 测试目录
tests/image_downloader/test_sync_downloader.py    # 同步下载测试
tests/image_downloader/test_async_downloader.py   # 异步下载测试
tests/image_downloader/fixtures/                 # 测试 fixtures
```

### 实现步骤

**步骤 1：环境准备**
- [ ] 安装可选依赖（如果需要图片验证）：`pip install Pillow>=10.0.0`
- [ ] 创建新文件目录：`src/image_downloader.py` 和 `tests/image_downloader/`
- [ ] 更新 `.env.example` 文件，添加图片下载配置项

**步骤 2：核心实现**
- [ ] 实现同步图片下载器（`ImageDownloader` 类）：
  - 从 Markdown 中提取图片 URL（正则表达式：`!\[.*?\]\((https?://[^\)]+)\)`）
  - 下载图片到本地目录（`images/`）
  - 替换 Markdown 中的图片 URL 为相对路径
  - 错误处理：网络失败、无效图片格式、文件系统错误
- [ ] 实现异步图片下载器（`AsyncImageDownloader` 类）：
  - 使用 `aiohttp` 异步下载
  - 批量下载（复用 `asyncio.Semaphore` 控制并发）
  - 与同步版本保持接口一致
- [ ] 添加图片去重机制（可选）：
  - 基于 URL 的去重（检查 Redis 或本地缓存）
  - 基于文件 hash 的去重（使用 MD5 或 SHA256）
- [ ] 添加图片验证逻辑（可选）：
  - 检查 Content-Type（仅下载 image/*）
  - 检查文件大小（防止下载超大文件）
  - 检查图片完整性（使用 Pillow 打开图片）
- [ ] 添加错误处理和输入验证：
  - 无效 URL 处理
  - 网络超时处理（默认 30 秒）
  - 磁盘空间不足处理
  - 文件名冲突处理（添加序号后缀）

**步骤 3：集成到现有系统**
- [ ] 修改 `config.py`：
  - 添加 `DOWNLOAD_IMAGES` 配置（默认 `False`，向后兼容）
  - 添加 `MAX_IMAGE_SIZE_MB` 配置（默认 10 MB）
  - 添加 `SUPPORTED_IMAGE_FORMATS` 配置（默认 `['.jpg', '.jpeg', '.png', '.gif', '.webp', '.svg']`）
  - 添加 `IMAGE_DOWNLOAD_TIMEOUT` 配置（默认 30 秒）
- [ ] 修改 `storage.py`:
  - 在 `save()` 方法中创建 `images/` 子目录
  - 在 `_generate_markdown()` 方法中调用图片下载器
  - 传递图片保存目录路径到下载器
  - 处理下载失败的情况（保留原始 URL）
- [ ] 修改 `fetcher.py` / `async_fetcher.py`（可选）：
  - 在 `WebPage` 对象中添加 `original_html` 字段（用于提取高清图片）
  - 默认不保存 HTML（节省内存），仅在启用图片下载时保存
- [ ] 更新日志输出：
  - 图片下载成功：`logger.info(f"✓ 图片已下载: {filename}")`
  - 图片下载失败：`logger.warning(f"⚠ 图片下载失败,保留原始URL: {url}")`
  - 图片去重：`logger.debug(f"图片已存在,跳过下载: {filename}")`

**步骤 4：测试**
- [ ] 测试同步图片下载器：
  - 单张图片下载
  - 多张图片批量下载
  - 无效 URL 处理
  - 网络超时处理
  - 文件名冲突处理
- [ ] 测试异步图片下载器：
  - 并发下载（5-10 张图片）
  - 信号量限制测试
  - 与同步版本结果一致性
- [ ] **回归测试现有功能**（必须！）：
  - 关闭图片下载功能（`DOWNLOAD_IMAGES=false`），验证爬虫功能正常
  - 测试同步和异步爬虫模式
  - 测试 Markdown 生成功能
  - 测试去重机制
- [ ] 边界测试：
  - 下载超大图片（> 10 MB）
  - 下载损坏的图片
  - 磁盘空间不足（模拟）
  - Markdown 中无图片的情况
- [ ] 修复发现的问题

**步骤 5：文档更新**
- [ ] 更新 `CHANGELOG.md`：
  - 版本号：v1.7.0（新增功能，MINOR 版本）
  - 记录新增图片下载功能和配置项
- [ ] 检查并更新 `CLAUDE.md` 文件：
  - 新增"图片处理"章节
  - 记录 `ImageDownloader` 类的使用方式
  - 记录新增的配置项和环境变量
- [ ] 判断是否需要更新 `README.md`：
  - ✅ **需要更新**：新增了用户可见的功能（图片下载）和配置项（`DOWNLOAD_IMAGES`）
  - 在"功能特性"章节添加图片本地化存储说明
  - 在"配置选项"章节添加 `DOWNLOAD_IMAGES` 配置说明
  - 在"使用示例"章节添加启用图片下载的命令示例
- [ ] 更新 `.env.example`：
  - 添加 `DOWNLOAD_IMAGES=false`
  - 添加 `MAX_IMAGE_SIZE_MB=10`
  - 添加 `IMAGE_DOWNLOAD_TIMEOUT=30`

**步骤 6：提交代码**
- [ ] 使用 git 提交新增需求的实现：
  ```bash
  git add .
  git commit -m "feat: 图片本地化存储"
  ```

---

## 使用方式

### 命令行
```bash
# 启用图片下载（通过环境变量）
DOWNLOAD_IMAGES=true python creeper.py input.md

# 或修改 .env 文件
DOWNLOAD_IMAGES=true
MAX_IMAGE_SIZE_MB=10
IMAGE_DOWNLOAD_TIMEOUT=30

# 运行爬虫
python creeper.py input.md
```

### 配置项
在 `.env` 文件中添加：
```ini
# 图片下载配置
DOWNLOAD_IMAGES=false              # 启用/禁用图片下载（默认 false）
MAX_IMAGE_SIZE_MB=10               # 最大图片大小（MB，默认 10）
IMAGE_DOWNLOAD_TIMEOUT=30          # 图片下载超时（秒，默认 30）
SUPPORTED_IMAGE_FORMATS=.jpg,.jpeg,.png,.gif,.webp,.svg  # 支持的图片格式
```

### 生成的目录结构
```
output/
├── H1_分类1/
│   ├── H2_子分类1/
│   │   ├── images/                    # 新增：图片目录
│   │   │   ├── python-logo.png
│   │   │   ├── diagram-1.jpg
│   │   │   └── screenshot.webp
│   │   ├── 网页标题1.md
│   │   └── 网页标题2.md
│   └── H2_子分类2/
│       ├── images/
│       │   └── banner.png
│       └── 网页标题3.md
```

### Markdown 中的图片引用
**原始 URL**（爬取前）：
```markdown
![Python Logo](https://example.com/images/python-logo.png)
```

**本地路径**（保存后）：
```markdown
![Python Logo](images/python-logo.png)
```

---

## 完成检查清单

**代码质量**：
- [ ] 遵循项目代码风格（PascalCase 类名，snake_case 方法名）
- [ ] 添加必要注释（类和方法的 docstring）
- [ ] 错误处理完善（网络失败、文件系统错误、无效 URL）
- [ ] 无安全漏洞（路径遍历、文件名注入、SSRF）

**测试**：
- [ ] 新功能测试通过（同步和异步下载）
- [ ] 现有功能无影响（关闭图片下载时爬虫正常）
- [ ] 边界条件处理（超大图片、损坏图片、无图片情况）

**文档**：
- [ ] README 已更新（新增功能说明和配置项）
- [ ] CHANGELOG 已更新（版本 v1.7.0）
- [ ] CLAUDE.md 已检查并更新（新增图片处理章节）
- [ ] .env.example 已更新（新增配置项）

---

## CHANGELOG.md 更新指南

**版本号规则**：新增功能（向后兼容）→ MINOR (x.7.0)

**模板**：
```markdown
## [1.7.0] - 2025-11-27

### Added
- **图片本地化存储**：自动下载 Markdown 中的图片到本地，替换为相对路径
  - 支持同步和异步下载模式（兼容现有爬虫）
  - 图片保存到 `output/<H1>/<H2>/images/` 目录
  - 支持图片格式：JPG, PNG, GIF, WebP, SVG
  - 图片去重机制（相同 URL 只下载一次）
  - 下载失败时保留原始 URL（不影响文档生成）
  - 相关文件：`src/image_downloader.py`, `src/storage.py`
  - 新增依赖：无（使用现有 requests/aiohttp）
  - 新增配置：`DOWNLOAD_IMAGES`, `MAX_IMAGE_SIZE_MB`, `IMAGE_DOWNLOAD_TIMEOUT`
```

**README.md 更新判断标准**：

**本功能需要更新 README.md**：
- ✅ 新增了用户可见的功能（图片本地化存储）
- ✅ 新增了配置选项（`DOWNLOAD_IMAGES` 等）
- ✅ 修改了输出结构（新增 `images/` 目录）

**更新内容**：
1. 在"功能特性"章节添加：
   ```markdown
   - 📷 **图片本地化存储**：自动下载网页中的图片到本地，生成离线可用的文档
   ```
2. 在"配置选项"章节添加：
   ```markdown
   - `DOWNLOAD_IMAGES`: 启用/禁用图片下载（默认 `false`）
   - `MAX_IMAGE_SIZE_MB`: 最大图片大小限制（默认 10 MB）
   ```
3. 在"使用示例"章节添加：
   ```bash
   # 启用图片下载
   DOWNLOAD_IMAGES=true python creeper.py input.md
   ```

**CLAUDE.md 文件更新判断**：

**本功能需要更新 CLAUDE.md**：
- ✅ 引入新的模块（`image_downloader.py`）和架构组件
- ✅ 新增配置项和环境变量
- ✅ 修改存储逻辑和目录结构

**更新内容**：
1. 在"架构设计 - 核心组件"章节添加：
   ```markdown
   **5. 图片处理**
   - `image_downloader.py`: 图片下载器（同步和异步版本）
     - 从 Markdown 提取图片 URL
     - 下载图片到 `images/` 子目录
     - 替换 URL 为相对路径
     - 图片去重和验证
   ```
2. 在"配置管理 - 关键配置项"章节添加：
   ```markdown
   - `DOWNLOAD_IMAGES`: 启用图片下载（默认: false）
   - `MAX_IMAGE_SIZE_MB`: 最大图片大小（默认: 10）
   - `IMAGE_DOWNLOAD_TIMEOUT`: 下载超时时间（默认: 30 秒）
   ```
3. 在"项目结构约定"章节更新：
   ```markdown
   - `output/<H1>/<H2>/images/`: 下载的图片文件（如果启用图片下载）
   ```

---

## 提交代码

在需求实现完成后，按以下顺序操作：

```bash
# 1. 更新 README.md（新增功能说明和配置项）
# 2. 更新 CLAUDE.md（新增图片处理章节）
# 3. 添加所有修改的文件
git add .
# 4. 提交，commit 信息使用需求文档的标题
git commit -m "feat: 图片本地化存储"
```

---

## 注意事项

**技术风险**：
- **磁盘空间占用**：大量图片可能占用大量磁盘空间，建议配置 `MAX_IMAGE_SIZE_MB` 限制
- **网络超时**：部分图片 URL 可能失效或响应慢，需要合理设置超时时间（默认 30 秒）
- **文件名冲突**：不同 URL 的图片可能生成相同文件名，需要添加序号后缀（如 `image-1.png`, `image-2.png`）
- **SSRF 风险**：需要验证图片 URL 的合法性，防止下载内网资源（如 `http://localhost/...`）

**兼容性**：
- ✅ **向后兼容**：默认 `DOWNLOAD_IMAGES=false`，不影响现有用户
- ✅ **无需迁移**：现有数据无需更改
- ✅ **不破坏 API**：不修改 `WebPage` 和 `URLItem` 的核心接口

**性能影响**：
- **下载时间**：图片下载会增加爬取时间（取决于图片数量和大小）
- **并发控制**：异步模式需要限制图片下载并发数（建议复用 `CONCURRENCY` 配置）
- **内存占用**：下载过程中需要缓存图片数据（使用流式下载减少内存占用）

**安全建议**：
- 验证图片 URL 的 scheme（仅允许 `http://` 和 `https://`）
- 验证 Content-Type（仅下载 `image/*`）
- 限制文件大小（防止下载炸弹）
- 使用安全的文件名生成（复用 `sanitize_filename()` 函数）
