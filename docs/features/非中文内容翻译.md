# 非中文内容翻译 - 需求文档

> 生成时间：2025-12-10
> 基于项目：Creeper
> 技术栈：Python + asyncio + langdetect

---

## 项目概况

**技术栈**：Python 3.8+ + asyncio + langdetect + DeepSeek API
**架构模式**：异步模块化
**代码风格**：snake_case 命名 / 中文注释

---

## 改动点

### 要实现什么
- 核心功能：将翻译触发条件从"仅英文内容翻译成中文"调整为"所有非中文内容翻译成中文"
- 覆盖范围：日文、韩文、法文、德文等所有非中文语言都将被翻译

### 与现有功能的关系
- 依赖现有模块：`src/translator.py` - 翻译核心逻辑
- 集成位置：
  - `src/translator.py:201-203` - `translate_webpage()` 方法的语言判断
  - `src/translator.py:228-236` - 字段级语言检测逻辑
  - `src/translator.py:147` - 翻译提示词

### 新增依赖（如有）
- 无需新增依赖

---

## 实现方案

### 需要修改的文件
```
src/translator.py  # 修改内容：调整翻译触发条件和提示词
```

### 需要新增的文件
```
无
```

### 实施步骤

**步骤 1：环境准备**
- [x] 无需安装新依赖
- [x] 无需创建新文件

**步骤 2：核心实现**

修改 `src/translator.py` 中的以下位置：

1. **修改 `translate_webpage()` 方法 (line 199-205)**
   - 当前：`if content_lang != "en":` 跳过翻译
   - 修改为：`if content_lang == "zh":` 跳过翻译（中文内容无需翻译）
   - 修改日志：从"内容非英文"改为"内容已是中文"

2. **修改字段级语言检测 (line 228-236)**
   - 当前：`if field_lang != "en":` 保留原文
   - 修改为：`if field_lang == "zh":` 保留原文

3. **调整翻译提示词 (line 147, 167)**
   - 当前：硬编码"英文"作为源语言
   - 修改为：根据检测到的语言动态设置源语言名称

4. **调整 `translate()` 方法的 source_lang 默认值 (line 109)**
   - 当前：默认 `source_lang = "en"`
   - 修改为：支持 `source_lang = "auto"`，根据检测结果自动设置

5. **更新 `original_language` 记录 (line 299)**
   - 当前：固定为 `"en"`
   - 修改为：使用实际检测到的语言代码

6. **扩展语言名称映射 (line 143)**
   - 当前：仅包含 `{"en": "英文", "zh": "中文"}`
   - 扩展为：包含更多常见语言的名称映射

**步骤 3：集成到现有系统**
- [ ] 无需额外集成，修改现有逻辑即可

**步骤 4：测试**
- [ ] 测试非中文内容（如英文、日文）是否正确触发翻译
- [ ] 测试中文内容是否正确跳过翻译
- [ ] **回归测试现有功能**：确保英文翻译功能仍正常工作

**步骤 5：文档更新**（必须执行）

| 文档 | 是否更新 | 原因 |
|------|----------|------|
| **CHANGELOG.md** | 是 | 功能变更必须记录 |
| **README.md** | 否 | 翻译功能本身已存在，仅调整触发条件 |
| **CLAUDE.md** | 是 | 需更新翻译策略说明 |

**CHANGELOG.md 更新内容**：
```markdown
### Changed
- **翻译功能**：翻译触发条件从"仅英文"调整为"所有非中文内容"
  - 支持日文、韩文、法文、德文等多语言翻译成中文
  - 相关文件：`src/translator.py`
```

**CLAUDE.md 更新内容**（翻译策略部分）：
```markdown
**翻译策略**
- 仅异步模式支持翻译
- 所有非中文内容自动翻译成中文（包括英、日、韩、法、德等）
- 批量处理段落以减少 API 调用
- 翻译失败时回退到原始内容
```

**步骤 6：提交代码**（必须执行）

```bash
git add .
git commit -m "feat: 翻译功能支持所有非中文内容

- 调整翻译触发条件：从仅英文改为所有非中文
- 支持日文、韩文、法文、德文等多语言翻译
- 动态设置源语言名称

🤖 Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>"
```

**步骤 7：自我检查**
- [ ] 非中文内容（英、日、韩等）正确触发翻译
- [ ] 中文内容正确跳过翻译
- [ ] 现有英文翻译功能正常
- [ ] CHANGELOG.md 已更新
- [ ] CLAUDE.md 已更新翻译策略说明

---

## 使用方式

### 命令行（无变化）
```bash
# 启用翻译功能后，所有非中文内容自动翻译
ENABLE_TRANSLATION=true python creeper.py inputs/input.md
```

### 配置项（无变化）
```env
ENABLE_TRANSLATION=true  # 启用翻译
```

---

## 注意事项

**技术风险**：
- langdetect 对短文本和混合语言的检测准确率可能有限
- 某些语言（如繁体中文）可能被误判为非中文

**兼容性**：
- 向后兼容：是（行为变更但 API 不变）
- 版本号：MINOR（功能增强，不破坏现有接口）

**边界情况**：
- 混合语言内容（如中英混排）：依赖 langdetect 的检测结果
- 繁体中文：langdetect 返回 `zh-tw`，已在代码中处理为中文
