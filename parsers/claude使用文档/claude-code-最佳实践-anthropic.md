# Claude Code 最佳实践 - 文档分析

## 文档概览
**文件路径**：outputs/claude使用文档/个人文章/claude-code-最佳实践-anthropic.md
**文档类型**：最佳实践指南
**主题**：Claude Code 命令行编程工具的高效使用方法和最佳实践

## 核心内容

### 概念定义

- **Claude Code**：一款用于代理式编码的命令行工具，提供接近原始模型的访问能力，帮助工程师深度集成到开发工作流中
- **CLAUDE.md**：特殊配置文件，Claude 会在开始对话时自动将其拉入上下文
- **MCP (Model Context Protocol)**：模型上下文协议，允许 Claude 连接到外部工具服务器
- **无头模式 (Headless Mode)**：在非交互式环境中运行 Claude，适用于 CI、git 钩子等自动化场景

### 功能说明

- **环境定制**：通过 CLAUDE.md 文件提供项目特定上下文
- **工具扩展**：支持 bash 工具、MCP 服务器和自定义斜杠命令
- **工作流模式**：提供多种编码工作流，如探索-规划-编码-提交、TDD 等
- **自动化集成**：支持与 git、GitHub、Jupyter 笔记本等工具交互
- **多实例协作**：支持同时运行多个 Claude 实例协同工作

## 操作步骤

### 环境定制与配置

#### 步骤 1：创建 CLAUDE.md 文件

**说明**：在项目根目录、父/子目录或用户主目录中创建 CLAUDE.md 文件

**文件位置选项**：
- 仓库根目录（最常见用法）
- 运行 `claude` 的目录的任何父目录
- 运行 `claude` 的目录的任何子目录
- 用户主文件夹 (`~/.claude/CLAUDE.md`)

**示例内容**：
```
# Bash 命令
- npm run build：构建项目
- npm run typecheck：运行类型检查器
# 代码风格
- 使用 ES 模块 (import/export) 语法，而不是 CommonJS (require)
- 尽可能解构导入 (例如 import { foo } from 'bar')
# 工作流
- 在完成一系列代码更改后，请务必进行类型检查
- 出于性能考虑，首选运行单个测试，而不是整个测试套件
```

#### 步骤 2：管理工具权限

**权限管理方法**：
- 在会话期间提示时选择"始终允许"
- 使用 `/permissions` 命令添加或删除工具
- 手动编辑 `.claude/settings.json` 或 `~/.claude.json`
- 使用 `--allowedTools` CLI 标志

#### 步骤 3：安装 GitHub CLI

**命令**：
```bash
# 安装 gh CLI 工具
```

### 扩展 Claude 的工具集

#### 步骤 1：使用 bash 工具

**说明**：告诉 Claude 工具名称和使用示例，或在 CLAUDE.md 中记录常用工具

#### 步骤 2：配置 MCP 连接

**MCP 连接方式**：
- 在项目配置中 (`.mcp.json`)
- 在全局配置中
- 在签入的配置文件中

**调试命令**：
```bash
claude --mcp-debug
```

#### 步骤 3：创建自定义斜杠命令

**说明**：在 `.claude/commands` 文件夹中创建 Markdown 文件定义重复工作流

**示例命令文件** (`fix-github-issue.md`)：
```
请分析并修复 GitHub issue：$ARGUMENTS。
请遵循以下步骤：
1. 使用 `gh issue view` 获取 issue 详细信息
2. 理解 issue 中描述的问题
3. 在代码库中搜索相关文件
4. 实现必要的更改以修复 issue
5. 编写并运行测试以验证修复
6. 确保代码通过 linting 和类型检查
7. 创建描述性的提交消息
8. 推送并创建 PR
请记住使用 GitHub CLI (`gh`) 处理所有与 GitHub 相关的任务。
```

### 工作流模式

#### 探索、规划、编码、提交工作流

**步骤 1：探索**
- 说明：要求 Claude 阅读相关文件、图像或 URL，提供一般性指引或特定文件名
- 命令：明确告诉 Claude 暂时不要编写任何代码

**步骤 2：规划**
- 说明：要求 Claude 制定解决问题的计划，使用"think"指令触发扩展思考模式
- 思考级别："think" < "think hard" < "think harder" < "ultrathink"

**步骤 3：编码**
- 说明：要求 Claude 在代码中实现其解决方案，验证解决方案合理性

**步骤 4：提交**
- 说明：要求 Claude 提交结果并创建拉取请求，更新 README 或变更日志

#### 测试驱动开发 (TDD) 工作流

**步骤 1：编写测试**
- 说明：要求 Claude 基于预期的输入/输出对编写测试
- 注意事项：明确指出正在进行 TDD，避免创建模拟实现

**步骤 2：验证测试失败**
- 说明：告诉 Claude 运行测试并确认它们失败
- 注意事项：明确告诉它不要编写任何实现代码

**步骤 3：提交测试**
- 说明：当对测试满意时，要求 Claude 提交测试

**步骤 4：编写实现代码**
- 说明：要求 Claude 编写通过测试的代码，指示它不要修改测试
- 命令：继续迭代直到所有测试都通过

**步骤 5：提交代码**
- 说明：一旦对更改满意，要求 Claude 提交代码

#### 基于视觉反馈迭代工作流

**步骤 1：提供截图能力**
- 说明：为 Claude 提供截取浏览器截图的方法

**步骤 2：提供视觉模型**
- 说明：通过复制/粘贴、拖放图像或提供图像文件路径，为 Claude 提供视觉模型

**步骤 3：实现和迭代**
- 说明：要求 Claude 在代码中实现设计，截取结果图，并迭代直到与模型匹配

**步骤 4：提交**
- 说明：当满意时，要求 Claude 提交

## 配置参数

### CLAUDE.md 文件配置

| 配置项 | 类型 | 默认值 | 说明 | 是否必填 |
|--------|------|--------|------|---------|
| 常用命令 | 列表 | 无 | 记录项目常用 bash 命令 | ✗ |
| 代码风格 | 文本 | 无 | 定义代码风格指南 | ✗ |
| 测试说明 | 文本 | 无 | 测试相关指令 | ✗ |
| 仓库礼仪 | 文本 | 无 | 分支命名、merge vs. rebase 等 | ✗ |
| 环境设置 | 文本 | 无 | 开发者环境设置说明 | ✗ |

### 权限管理配置

| 权限类型 | 示例命令 | 说明 | 风险等级 |
|----------|----------|------|---------|
| 文件编辑 | `Edit` | 允许文件编辑操作 | 中 |
| Git 提交 | `Bash(git commit:*)` | 允许 git 提交操作 | 低 |
| MCP 工具 | `mcp__puppeteer__puppeteer_navigate` | 允许使用 Puppeteer MCP 服务器 | 中 |

## 代码示例

### 自定义斜杠命令示例

#### 示例 1：GitHub Issue 修复命令
```markdown
请分析并修复 GitHub issue：$ARGUMENTS。
请遵循以下步骤：
1. 使用 `gh issue view` 获取 issue 详细信息
2. 理解 issue 中描述的问题
3. 在代码库中搜索相关文件
4. 实现必要的更改以修复 issue
5. 编写并运行测试以验证修复
6. 确保代码通过 linting 和类型检查
7. 创建描述性的提交消息
8. 推送并创建 PR
请记住使用 GitHub CLI (`gh`) 处理所有与 GitHub 相关的任务。
```

### 无头模式使用示例

#### 示例 2：自动化迁移脚本
```bash
claude -p "将 foo.py 从 React 迁移到 Vue。完成后，如果成功，您必须返回字符串 OK，如果任务失败，则返回 FAIL。" --allowedTools Edit Bash(git commit:*)
```

#### 示例 3：流水线集成
```bash
claude -p "<您的提示>" --json | your_command
```

## 最佳实践与技巧

### 指导方针

- **具体指令**：指令越具体，Claude 的首次成功率越高
  ```bash
  # 差：为 foo.py 添加测试
  # 好：为 foo.py 编写一个新的测试用例，覆盖用户未登录的边缘情况。避免使用模拟（mock）
  ```

- **视觉信息利用**：通过粘贴、拖拽或提供文件路径的方式给 Claude 发送图片、图表和设计稿

- **及早修正**：在 Claude 执行任务时保持监督，使用 Escape 键中断当前操作进行方向调整

- **上下文清理**：在任务切换时，使用 `/clear` 命令清空上下文窗口

- **清单和暂存盘**：对于复杂任务，让 Claude 将步骤和错误记录在 Markdown 文件中逐项处理

### 优化建议

- 使用 tab 键自动补全功能快速引用文件或文件夹
- 为 Claude 提供 URL 获取额外信息
- 使用 `/permissions` 将常用域添加到允许列表
- 在长时间会话期间经常使用 `/clear` 保持上下文集中

## ⚠️ 注意事项、限制与故障排除

### 安全警告

- ⚠️ **安全 YOLO 模式**：使用 `claude --dangerously-skip-permissions` 绕过所有权限检查有风险，可能导致数据丢失、系统损坏或数据泄露
- ⚠️ **防护措施**：在没有互联网访问的容器中使用 `--dangerously-skip-permissions`

### 性能优化

- 保持 CLAUDE.md 文件简洁有效
- 在任务之间使用 `/clear` 命令重置上下文窗口
- 对于复杂工作流使用清单和草稿板

### 限制和兼容性

- **无头模式限制**：无头模式在会话之间不会持久存在，必须在每个会话中触发
- **思考预算**：思考指令有预算限制："think" < "think hard" < "think harder" < "ultrathink"

### 故障排除提示

- 使用 `--mcp-debug` 标志识别 MCP 配置问题
- 使用 `--verbose` 标志调试 Claude 调用
- 使用 Escape 键中断 Claude 操作进行重定向
- 双击 Escape 键跳回历史记录编辑先前提示

### 多 Claude 工作流技巧

- 让一个 Claude 编写代码，另一个进行审查或测试
- 使用 git worktree 创建多个工作目录并行处理任务
- 在单独的终端选项卡中运行多个 Claude 实例

### 相关链接
- 官方文档：claude.ai/code
- GitHub CLI：https://cli.github.com/